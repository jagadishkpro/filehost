<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Company Data Processor</title>
    <style>
        table, th, td {
            border: 1px solid black;
            border-collapse: collapse;
        }
        th, td {
            padding: 10px;
        }
    </style>
</head>
<body>

<h2>Company Data Processor</h2>

<button onclick="startProcessing()">Start Processing</button>

<table id="statusTable">
    <thead>
        <tr>
            <th>Name</th>
            <th>Symbol</th>
            <th>Status</th>
        </tr>
    </thead>
    <tbody>
        <!-- Rows will be dynamically added here -->
    </tbody>
</table>

<script>
    const AIRTABLE_API_KEY = 'keyEAqqRoOK04LGWi';
    const OPENAI_API_KEY = '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';
    const AIRTABLE_ENDPOINT = 'https://api.airtable.com/v0';

    async function fetchDataFromAirtable(baseId, tableName) {
        const url = `${AIRTABLE_ENDPOINT}/${baseId}/${tableName}`;
        const headers = new Headers({
            'Authorization': `Bearer ${AIRTABLE_API_KEY}`,
            'Content-Type': 'application/json'
        });

        const response = await fetch(url, { method: 'GET', headers: headers });
        const data = await response.json();
        return data.records;
    }

    async function updateStatusTable(baseId, tableName, companyId, status) {
        const url = `${AIRTABLE_ENDPOINT}/${baseId}/${tableName}/${companyId}`;
        const headers = new Headers({
            'Authorization': `Bearer ${AIRTABLE_API_KEY}`,
            'Content-Type': 'application/json'
        });
        //headers.append("Access-Control-Allow-Origin", "*");
        const data = {
            fields: {
                Status: status
            }
        };

        await fetch(url, { method: 'PATCH', body: JSON.stringify(data), headers: headers });
    }

    async function getSummaryFromOpenAI(data) {
        const OPENAI_ENDPOINT = 'https://api.openai.com/v2/engines/davinci/completions';
        const headers = new Headers({
            'Authorization': `Bearer ${OPENAI_API_KEY}`,
            'Content-Type': 'application/json'
        });

        const prompt = `Please summarize the company's performance in a simple manner: ${data}`;
        const response = await fetch(OPENAI_ENDPOINT, {
            method: 'POST',
            body: JSON.stringify({ prompt: prompt, max_tokens: 150 }),
            headers: headers
        });

        const responseData = await response.json();
        return responseData.choices[0].text.trim();
    }

    async function storeSummaryInFinvyAI(symbol, name, summary) {
    const baseId = 'app89rCo4ldtfodPz';  // Replace with the actual Base ID for "FinvyAI"
    const tableName = 'FinvyAI';
    const url = `${AIRTABLE_ENDPOINT}/${baseId}/${tableName}`;
    const headers = new Headers({
        'Authorization': `Bearer ${AIRTABLE_API_KEY}`,
        'Content-Type': 'application/json'
    });

    const data = {
        fields: {
            Symbol: symbol,
            Name: name,
            Description: summary
        }
    };

    await fetch(url, { method: 'POST', body: JSON.stringify(data), headers: headers });
}

async function startProcessing() {
    const companies = await fetchDataFromAirtable('appZkloxr3bNO6QiB', 'Companies');
    const tableBody = document.getElementById('statusTable').getElementsByTagName('tbody')[0];

    for (let company of companies) {
        const symbol = company.fields.Symbol;
        const name = company.fields.Name;

        // Add row to the table with status "Fetching"
        let newRow = tableBody.insertRow();
        newRow.insertCell(0).innerHTML = name;
        newRow.insertCell(1).innerHTML = symbol;
        newRow.insertCell(2).innerHTML = 'Fetching';

        // Fetch data for the specific symbol
        const incomeData = await fetchDataFromAirtable('appuhP8MLJzJeXzrE', 'IncomeStatement');
        // Fetch other tables (BalanceSheet, CashFlow, Metrics) in a similar manner...

        // Combine and format data
        const combinedData = `Income Data: ${JSON.stringify(incomeData)} ...`; // Add other data similarly

        // Get summary from OpenAI
        const summary = await getSummaryFromOpenAI(combinedData);

        // Store summary in FinvyAI database
        await storeSummaryInFinvyAI(symbol, name, summary);

        // Update the status in the table to "Done"
        newRow.cells[2].innerHTML = 'Done';

        // Delay to avoid hitting API rate limits
        await new Promise(resolve => setTimeout(resolve, 200));
    }
}

</script>

</body>
</html>
